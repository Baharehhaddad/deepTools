<tool id="deeptools_bam_correlate" name="bamCorrelate" version="@WRAPPER_VERSION@.0">
    <description>calculates average read coverages for a list of two or more BAM files</description>
    <macros>
        <token name="@BINARY@">bamCorrelate</token>
        <import>deepTools_macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command>
<![CDATA[
        #set files=[]
        #set labels=[]

        @multiple_input_bams@
        @BINARY@
            $mode.modeOpt
            @THREADS@

            --outFileName '$outFile'
            --bamfiles '#echo "' '".join($files)#'
            --labels '#echo "' '".join($labels)#'

            #if $outRawCounts:
                --outRawCounts '$outFileRawCounts'
            #end if

            #if $mode.modeOpt == "bins":
                --binSize '$mode.binSize'
                --distanceBetweenBins '$mode.distanceBetweenBins'
            #else:
                --BED $mode.region_file
            #end if

            #if str($region).strip() != '':
                --region '$region'
            #end if

            #if $advancedOpt.showAdvancedOpt == "yes":
                @ADVANCED_OPTS_READ_PROCESSING@
            #end if
]]>
    </command>

    <inputs>
        <expand macro="multiple_input_bams" />

        <conditional name="mode">
            <param name="modeOpt" type="select" label="Choose computation mode" 
                    help="In the bins mode, the coverage is computed for equal
                    length bins. In the BED file mode, as list of genomic regions in BED
                    format has to be given. For each region in the BED file the number of
                    overlapping reads is counted in each of the BAM files.
                    ">
                <option value="bins" selected="true">Bins</option>
                <option value="BED-file">Limit calculation to certain regions (BED file)</option>
            </param>
            <when value="bins">
                <param name="binSize" type="integer" value="10000" min="1"
                    label="Bin size in bp"
                    help="Length in base pairs for a window used to sample the genome. (--binSize)"/>

                <expand macro="distanceBetweenBins" />

            </when>
            <when value="BED-file">
                <param name="region_file" type="data" format="bed"
                    label="Region file in BED format"
                    help="Coverage is computed for the number of reads that overlap such regions."/>
            </when>
        </conditional>

        <expand macro="region_limit_operation" />

        <expand macro="advancedOpt_scaffold">
            <expand macro="read_processing_options" />
        </expand>

        <param argument="--outRawCounts" type="boolean" label="Save raw counts (coverages) to file" help=""/>

    </inputs>
    <outputs>
        <data format="deeptools_coverage_matrix" name="outFile" label="${tool.name} on ${on_string}: correlation matrix" />
        <data format="tabular" name="outFileRawCounts" label="${tool.name} on ${on_string}: bin counts">
            <filter>outRawCounts is True</filter>
        </data>
    </outputs>
    <tests>
        <test>
            <param name="bamfiles" value="bowtie2-test1.bam,bowtie2-test1.bam" ftype="bam" />
            <param name="modeOpt" value="bins" />
            <param name="binSize" value="10" />
            <output name="outFile" file="bamCorrelate_result1.npz" ftype="deeptools_coverage_matrix" compare="sim_size" />
        </test>
        <test>
            <param name="bamfiles" value="bowtie2-test1.bam,bowtie2-test1.bam" ftype="bam" />
            <param name="modeOpt" value="BED-file" />
            <param name="region_file" value="bamCorrelate_regions.bed" />
            <output name="outFile" file="bamCorrelate_result2.npz" ftype="deeptools_coverage_matrix" compare="sim_size" />
        </test>


    </tests>
    <help>
<![CDATA[

**What it does**

This tool generates a matrix of read-coverages for a list of genomic regions and a number of two or more samples (BAM files)
The tool splits the genome into bins of given length. For each bin, the number of reads found in each BAM file is counted.
Alternatively, a bed file with pre-defined genomic regions can be provided. In each case the calculation can further be limited to
a given genomic interval (e.g. a given chromosome). This option is mostly used for testing and efficiency.
A typical follow-up application is to check and visuzalize the similarity between replicates or published data sets (see: plotPCA and plotCorrelation).

**Output files**:

- **score matrix**: a compressed matrix where every row correponds to a genome region (or bin) and each column corresponds to a sample (BAM file)
- Optional : Uncompressed **score matrix**, in case you want to analyse the coverage scores yourself. (Select to "Save raw counts" from above)

=======

.. image:: $PATH_TO_IMAGES/QC_bamCorrelate_humanSamples.png
   :alt: Heatmap of RNA Polymerase II ChIP-seq


You can find more details on the bamCorrelate doc page: https://deeptools.readthedocs.org/en/release-1.6/content/tools/bamCorrelate.html

-----

@REFERENCES@
]]>
    </help>
    <expand macro="citations" />
</tool>
